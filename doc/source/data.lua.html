<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>polycore</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="nowrap">
  <li><a href="../source/widget.lua.html">widget.lua</a></li>
  <li><strong>data.lua</strong></li>
  <li><a href="../source/cairo_helpers.lua.html">cairo_helpers.lua</a></li>
  <li><a href="../source/util.lua.html">util.lua</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/widget.html">widget</a></li>
  <li><a href="../modules/data.html">data</a></li>
  <li><a href="../modules/cairo_helpers.html">cairo_helpers</a></li>
  <li><a href="../modules/util.html">util</a></li>
</ul>

</div>

<div id="content">

    <h2>data.lua</h2>
<pre>
<span class="comment">--- Data gathering facilities for conky widgets
</span><span class="comment">-- @module data
</span>
<span class="keyword">local</span> util = <span class="global">require</span> <span class="string">'util'</span>

<span class="keyword">local</span> data = {}

<span class="keyword">local</span> read_cmd = util.memoize(<span class="number">1</span>, <span class="keyword">function</span>(cmd)
    <span class="keyword">local</span> pipe = <span class="global">io</span>.popen(cmd)
    <span class="keyword">local</span> result = pipe:read(<span class="string">"*a"</span>)
    pipe:close()
    <span class="keyword">return</span> result
<span class="keyword">end</span>)

<span class="comment">--- Get the current usage percentages of individual CPU cores
</span><span class="comment">-- @int cores number of CPU cores
</span><a id="18"></a><span class="comment">-- @treturn {number,...}
</span><span class="keyword">function</span> data.cpu_percentages(cores)
    <span class="keyword">local</span> conky_string = <span class="string">"${cpu cpu1}"</span>
    <span class="keyword">for</span> i = <span class="number">2</span>, cores <span class="keyword">do</span>
        conky_string = conky_string .. <span class="string">"|${cpu cpu"</span> .. i .. <span class="string">"}"</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> util.map(<span class="global">tonumber</span>, conky_parse(conky_string):gmatch(<span class="string">"%d+"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get the current frequencies at which individual CPU cores are running
</span><span class="comment">-- @int cores number of CPU cores
</span><a id="29"></a><span class="comment">-- @treturn {number,...}
</span><span class="keyword">function</span> data.cpu_frequencies(cores)
    <span class="keyword">local</span> conky_string = <span class="string">"${freq_g 1}"</span>
    <span class="keyword">for</span> i = <span class="number">2</span>, cores <span class="keyword">do</span>
        conky_string = conky_string .. <span class="string">"|${freq_g "</span> .. i .. <span class="string">"}"</span>
    <span class="keyword">end</span>
    <span class="keyword">return</span> util.map(<span class="global">tonumber</span>, conky_parse(conky_string):gmatch(<span class="string">"%d+[,.]?%d*"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get the current CPU core temperatures
</span><span class="comment">-- relies on lm_sensors to be installed
</span><a id="40"></a><span class="comment">-- @treturn {number,...}
</span><span class="keyword">function</span> data.cpu_temperatures()
    <span class="keyword">return</span> util.map(<span class="global">tonumber</span>, read_cmd(<span class="string">"sensors"</span>):gmatch(<span class="string">"Core %d: +%+(%d%d)"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get the current speed of fans in the system
</span><span class="comment">-- relies on lm_sensors to be installed
</span><a id="47"></a><span class="comment">-- @treturn {number,...}
</span><span class="keyword">function</span> data.fan_rpm()
    <span class="keyword">return</span> util.map(<span class="global">tonumber</span>, read_cmd(<span class="string">"sensors"</span>):gmatch(<span class="string">"fan%d: +(%d+) RPM"</span>))
<span class="keyword">end</span>

<span class="keyword">local</span> unit_map = {
    T = <span class="number">1024</span>,
    G = <span class="number">1</span>,
    M = <span class="number">1</span> / <span class="number">1024</span>,
    k = <span class="number">1</span> / (<span class="number">1024</span> * <span class="number">1024</span>),
    B = <span class="number">1</span> / (<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>),
}
<span class="comment">--- Get current memory usage info
</span><a id="60"></a><span class="comment">-- @treturn number,number,number,number usage, easyfree, free, total
</span><span class="keyword">function</span> data.memory()
    <span class="keyword">local</span> conky_output = conky_parse(<span class="string">"$mem|$memeasyfree|$memfree|$memmax"</span>)
    <span class="keyword">local</span> results = {}
    <span class="keyword">for</span> result <span class="keyword">in</span> conky_output:gmatch(<span class="string">"%d+[,.]?%d*%a"</span>) <span class="keyword">do</span>
        <span class="keyword">local</span> value, unit = result:sub(<span class="number">1</span>, -<span class="number">2</span>), result:sub(-<span class="number">1</span>)
        <span class="global">table</span>.insert(results, value * unit_map[unit])
    <span class="keyword">end</span>
    <span class="keyword">return</span> <span class="global">unpack</span>(results)
<span class="keyword">end</span>

<span class="comment">--- Get volume of down- and uploaded data since last conky update cycle.
</span><span class="comment">-- @string interface e.g. "eth0"
</span><a id="73"></a><span class="comment">-- @treturn number,number downspeed and upspeed in KiB
</span><span class="keyword">function</span> data.network_speed(interface)
    <span class="keyword">local</span> result = conky_parse(<span class="global">string</span>.format(<span class="string">"${downspeedf %s}|${upspeedf %s}"</span>, interface, interface))
    <span class="keyword">return</span> <span class="global">unpack</span>(util.map(<span class="global">tonumber</span>, result:gmatch(<span class="string">"%d+[,.]?%d*"</span>)))
<span class="keyword">end</span>

<span class="comment">-- relies on nvidia-smi to be installed.
</span><span class="keyword">local</span> <span class="keyword">function</span> cmd_nvidia_smi()
    <span class="keyword">return</span> read_cmd(<span class="string">"nvidia-smi -q -d UTILIZATION,MEMORY,TEMPERATURE"</span>)
<span class="keyword">end</span>

<span class="comment">--- Get current GPU usage in percent.
</span><span class="comment">-- Relies on nvidia-smi to be installed.
</span><a id="86"></a><span class="comment">-- @treturn number
</span><span class="keyword">function</span> data.gpu_percentage()
    <span class="keyword">return</span> <span class="global">tonumber</span>(cmd_nvidia_smi():match(<span class="string">"Gpu%s+: (%d+) %%"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get current GPU frequency.
</span><a id="92"></a><span class="comment">-- @treturn number
</span><span class="keyword">function</span> data.gpu_frequency()
    <span class="keyword">return</span> <span class="global">tonumber</span>(conky_parse(<span class="string">"${nvidia gpufreq}"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get current GPU temperature.
</span><span class="comment">-- Relies on nvidia-smi to be installed.
</span><a id="99"></a><span class="comment">-- @treturn number temperature in Â°C
</span><span class="keyword">function</span> data.gpu_temperature()
    <span class="keyword">return</span> <span class="global">tonumber</span>(cmd_nvidia_smi():match(<span class="string">"GPU Current Temp%s+: (%d+) C"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get current VRAM usage.
</span><span class="comment">-- Relies on nvidia-smi to be installed.
</span><a id="106"></a><span class="comment">-- @treturn number,number used, total in MiB
</span><span class="keyword">function</span> data.gpu_memory()
    <span class="keyword">return</span> <span class="global">tonumber</span>(cmd_nvidia_smi():match(<span class="string">"Used%s+: (%d+) MiB"</span>)),
           <span class="global">tonumber</span>(cmd_nvidia_smi():match(<span class="string">"Total%s+: (%d+) MiB"</span>))
<span class="keyword">end</span>

<span class="comment">--- Get list of GPU processes with individual VRAM usage in MiB.
</span><span class="comment">-- Relies on nvidia-smi to be installed.
</span><a id="114"></a><span class="comment">-- @treturn {{string,number},...} list of {name, mem} value pairs.
</span><span class="keyword">function</span> data.gpu_top()
    <span class="keyword">local</span> output = read_cmd(<span class="string">"nvidia-smi -q -d PIDS"</span>)
    <span class="keyword">local</span> processes = {}
    <span class="keyword">for</span> name, mem <span class="keyword">in</span> output:gmatch(<span class="string">"Name%s+: %S*/(%S+)[^\n]*\n%s+Used GPU Memory%s+: (%d+)"</span>) <span class="keyword">do</span>
        processes[#processes + <span class="number">1</span>] = {name, <span class="global">tonumber</span>(mem)}
    <span class="keyword">end</span>
    <span class="global">table</span>.sort(processes, <span class="keyword">function</span>(proc1, proc2) <span class="keyword">return</span> proc1[<span class="number">2</span>] &gt; proc2[<span class="number">2</span>] <span class="keyword">end</span>)
    <span class="keyword">return</span> processes
<span class="keyword">end</span>

<span class="comment">--- Get the drive usage in percent for the given path.
</span><span class="comment">-- @function data.drive_percentag
</span><span class="comment">-- @string path
</span><a id="128"></a><span class="comment">-- @treturn number
</span>data.drive_percentage = util.memoize(<span class="number">5</span>, <span class="keyword">function</span>(path)
    <span class="keyword">return</span> <span class="global">tonumber</span>(conky_parse(<span class="global">string</span>.format(<span class="string">"${fs_used_perc %s}"</span>, path)))
<span class="keyword">end</span>)


<span class="comment">--- Is the given path a mount? (see conky's is_mounted)
</span><span class="comment">-- @function data.is_mounted
</span><span class="comment">-- @string path
</span><a id="137"></a><span class="comment">-- @treturn bool
</span>data.is_mounted = util.memoize(<span class="number">5</span>, <span class="keyword">function</span>(path)
    <span class="keyword">return</span> <span class="string">"1"</span> == conky_parse(<span class="global">string</span>.format(<span class="string">"${if_mounted %s}1${else}0${endif}"</span>, path))
<span class="keyword">end</span>)

<span class="comment">--- Get current HDD/SSD temperatures.
</span><span class="comment">-- Relies on hddtemp to be running daemon mode. The results depend on what
</span><span class="comment">-- hddtemp reports and may require manual configuration,
</span><span class="comment">-- e.g. via /etc/default/hddtemp
</span><span class="comment">-- For experimental NVME support, requires "nvme smart-log" to be available
</span><span class="comment">-- and added as an exception in sudoers, hddtemp does not support NVME.
</span><span class="comment">-- @function data.hddtemp
</span><a id="149"></a><span class="comment">-- @treturn table mapping device names to temperature values
</span>data.hddtemp = util.memoize(<span class="number">5</span>, <span class="keyword">function</span>()
    <span class="keyword">local</span> result = read_cmd(<span class="string">"nc localhost 7634 -d"</span>)
    <span class="keyword">local</span> temperatures = {}
    <span class="keyword">for</span> _, device_name, temp <span class="keyword">in</span> result:gmatch(<span class="string">"|([^|]+)|([^|]+)|(%d+)|C|"</span>) <span class="keyword">do</span>
        temperatures[device_name] = <span class="global">tonumber</span>(temp)
    <span class="keyword">end</span>
    <span class="comment">-- experimental: nvme drives, currently requires sudo
</span>    result = read_cmd(<span class="string">"sudo nvme smart-log /dev/nvme0"</span>)
    temperatures[<span class="string">"/dev/nvme0"</span>] = <span class="global">tonumber</span>(result:match(<span class="string">"temperature%s+: (%d+) C"</span>))
    <span class="keyword">return</span> temperatures
<span class="keyword">end</span>)

<span class="keyword">return</span> data</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2019-11-01 17:47:03 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
